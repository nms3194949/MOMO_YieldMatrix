<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>FundMetric Proï½œOptimizer (Rows Select)</title>
<meta name="theme-color" content="#0A1221" />
<style>
:root{
  --deep:#0A1221; --card:#0C152A; --ink:#EDEFF5; --muted:#A7B0C0;
  --gold:#C9A227; --gold-soft:#E9D18A; --line:rgba(233,209,138,.22);
  --ok:#2D7A77; --warn:#B6801E; --err:#C6535C;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang TC","Microsoft JhengHei",sans-serif;color:var(--ink);
  background:radial-gradient(1200px 600px at 70% -10%, #132041 0%, #0A1221 40%, #07101F 100%);
}
header{padding:28px 16px 6px; text-align:center}
h1{margin:0; font-size:26px}
.sub{color:var(--muted); font-size:13px; margin-top:6px}
.wrap{max-width:1200px; margin:16px auto 60px; padding:0 14px}
.panel{background:linear-gradient(180deg, rgba(12,21,42,.85), rgba(10,18,33,.95)); border:1px solid var(--line); border-radius:14px; padding:16px;}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.spread{display:flex; justify-content:space-between; align-items:center}
button{background:linear-gradient(90deg,#F9E27C 0%,#D9B84B 50%,#B88A1E 100%); color:#1A1404; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer}
button.secondary{background:transparent; color:var(--gold-soft); border:1px solid var(--line)}
button.ghost{background:transparent; color:var(--muted); border:1px dashed var(--line)}
.small{font-size:12px; color:var(--muted)}
.badge{display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; color:var(--gold-soft); font-size:12px}
table{width:100%; border-collapse:collapse; margin-top:10px; font-size:14px}
th,td{border-bottom:1px dashed var(--line); padding:8px 6px; text-align:center}
th{color:var(--gold-soft); font-weight:700}
td input{width:100%; background:#0F1A34; color:var(--ink); border:1px solid rgba(255,255,255,.08); border-radius:8px; padding:8px 8px; font-size:14px; outline:none;}
td input:focus{border-color:var(--gold-soft)}
/* ç·Šæ¹Šæ¨¡å¼ */
.compact th,.compact td{padding:4px 6px}
.compact td input{padding:6px 8px; font-size:13px}

.export-bar{display:flex; flex-wrap:wrap; gap:14px; align-items:center; border:1px dashed var(--line); border-radius:12px; padding:10px 12px; margin-top:14px}
.export-bar label{display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted)}
.export-bar input[type=checkbox]{transform:scale(1.05); accent-color:#D9B84B}
.summary-box{margin-top:12px; padding:14px; background:linear-gradient(180deg, rgba(14,24,46,.92), rgba(9,16,29,.96)); border:1px solid var(--line); border-radius:14px;}
.status{display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px dashed var(--line); border-radius:10px;}
.lamp{width:10px; height:10px; border-radius:50%}
.lamp.red{background:#C6535C; box-shadow:0 0 8px rgba(198,83,92,.8)}
.lamp.green{background:#2D7A77; box-shadow:0 0 8px rgba(45,122,119,.8)}
.lamp.amber{background:#B6801E; box-shadow:0 0 8px rgba(182,128,30,.8)}

/* è¼¸å…¥è¡¨ï¼šå›ºå®šé«˜åº¦ + å‚ç›´æ²å‹•è»¸ */
#inputScroll{
  max-height:520px; 
  overflow-y:auto; 
  overflow-x:hidden; 
  border:1px dashed var(--line); 
  border-radius:12px; 
  padding:2px;
  scrollbar-gutter: stable; /* æ²å‹•æ™‚ä¸è·³å‹• */
}
#tbl thead th{position:sticky; top:0; background:#0C152A; z-index:1}

/* æ§åˆ¶åˆ— */
.controls{display:flex; gap:16px; flex-wrap:wrap; align-items:center}
.sort-group{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.sort-group .chip{padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#0F1A34; color:#cfd7ea; cursor:pointer; font-size:13px}
.sort-group .chip.active{color:#1A1404; background:linear-gradient(90deg,#F9E27C 0%,#D9B84B 50%,#B88A1E 100%); border-color:transparent; font-weight:700}
.input{background:#0F1A34; color:#EDEFF5; border:1px solid rgba(255,255,255,.12); border-radius:8px; padding:8px 10px; font-size:14px}
.select{background:#0F1A34; color:#EDEFF5; border:1px solid rgba(255,255,255,.12); border-radius:8px; padding:8px 10px; font-size:14px}

.hint{background:#0F1A34; border:1px dashed var(--line); border-radius:12px; padding:10px 12px; color:#cfd7ea; font-size:13px; line-height:1.6}
.hint b{color:#E9D18A}
.hidden-row{display:none!important}
@media (max-width:980px){table{font-size:13px} td input{font-size:13px}}
</style>
</head>
<body>
<header>
  <h1>FundMetric Pro <span class="badge">Optimizer</span></h1>
  <div class="sub">å³æ™‚è¨ˆç®—ï½œæ’åºï½œå¯æ²å‹•è¼¸å…¥è¡¨ï½œæ‘˜è¦/åŒ¯å‡ºåŒæ­¥å‹¾é¸ï½œè¨­å®šæŒä¹…åŒ–</div>
</header>

<div class="wrap">
  <!-- å·¥å…·åˆ— + ç‡ˆè™Ÿ -->
  <div class="panel">
    <div class="row" style="width:100%">
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" />
      <button id="btnImport">åŒ¯å…¥ Excel</button>
      <button class="secondary" id="btnAdd">æ–°å¢ä¸€ç­†åŸºé‡‘</button>
      <button class="ghost" id="btnClear">æ¸…ç©º</button>
      <button id="btnCalc">è¨ˆç®—å…¨éƒ¨</button>
      <div style="flex:1"></div>
      <div id="importStatus" class="status">
        <div id="lamp" class="lamp red"></div>
        <span id="lampText" class="small">æœªåŒ¯å…¥</span>
      </div>
    </div>
    <div class="small" style="margin-top:8px;color:var(--muted)">è¼¸å…¥è¡¨é è¨­é¡¯ç¤º <b>10</b> è¡Œï¼Œå¯æ”¹ 5/10/15/20/å…¨éƒ¨ã€‚</div>
  </div>

  <!-- æ’åº + è¡Œæ•¸ï¼ˆä¸‹æ‹‰ï¼‰ + ç¯©é¸ + é¡¯ç¤ºé¸é … -->
  <div class="panel" style="margin-top:12px">
    <div class="controls">
      <div class="sort-group" id="sortGroup" aria-label="æ’åº">
        <span class="small" style="margin-right:4px">æ’åºï¼š</span>
        <button class="chip" data-m="TWR">TWR</button>
        <button class="chip" data-m="MWR">MWR</button>
        <button class="chip" data-m="SAR">SAR</button>
        <button class="chip" data-m="RSI">RSI</button>
        <button class="chip active" data-m="MOMO">MOMOï¼ˆé è¨­ï¼‰</button>
      </div>

      <div class="row" style="gap:10px">
        <label class="small">è¼¸å…¥è¡¨é¡¯ç¤ºè¡Œæ•¸ï¼š</label>
        <select id="rowsSelect" class="select" aria-label="é¡¯ç¤ºè¡Œæ•¸">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="all">å…¨éƒ¨</option>
        </select>
        <span class="small" id="rowsInfo"></span>
      </div>

      <div class="row" style="gap:10px">
        <input id="filterName" class="input" placeholder="åç¨±ç¯©é¸ï¼ˆé—œéµå­—ï¼‰">
        <label class="small"><input type="checkbox" id="chkComputed"> åªé¡¯ç¤ºå·²è¨ˆç®—åˆ—</label>
        <label class="small"><input type="checkbox" id="chkCompact"> ç·Šæ¹Šæ¨¡å¼</label>
      </div>
    </div>
    <div class="hint" style="margin-top:10px">
      <b>TWR</b>ï¼šæ™‚é–“åŠ æ¬Šï¼›<b>MWR</b>ï¼šè³‡é‡‘åŠ æ¬Šï¼›<b>SAR</b>ï¼š1Y/3Y/5Y åŠ æ¬Š Ã— GCï¼›<b>RSI</b>ï¼šå¹³å‡å ±é…¬Ã·æ¨™æº–å·®ï¼›<b>MOMO</b>ï¼š0.4Ã—TWRáµ‘ + 0.3Ã—MWRáµ‘ + 0.3Ã—GCï¼ˆå« Coverage å¾®èª¿ï¼‰ã€‚
    </div>
  </div>

  <!-- ===== æŒ‡æ¨™èªªæ˜ Web Component å€å¡Š ===== -->
  <div class="panel" style="margin-top:12px">
    <div class="spread">
      <h3 style="margin:0;color:var(--gold-soft)">æŒ‡æ¨™èªªæ˜</h3>
      <span class="small">äº”å¡ä¸¦æ’ï½œå…¬å¼å¸¸é§ï½œâ“˜ Tooltip å¯é»æ“Šé–å®š</span>
    </div>
    <div style="margin-top:8px">
      <momo-metric title="åŸºé‡‘è©•åˆ†æŒ‡æ¨™èªªæ˜"></momo-metric>
    </div>
  </div>
  <!-- ===== /æŒ‡æ¨™èªªæ˜ ===== -->

  <!-- è¼¸å…¥è¡¨ï¼ˆå›ºå®šé«˜ï¼‹å‚ç›´æ²å‹•è»¸ï¼‰ -->
  <div class="panel" style="margin-top:12px">
    <div class="spread">
      <h3 style="margin:0;color:var(--gold-soft)">è¼¸å…¥è³‡æ–™è¡¨</h3>
      <div class="small">æ¬„ä½ï¼šåŸºé‡‘åç¨±ã€3Mã€6Mã€1Yã€3Yã€5Yï¼ˆå¯è¼¸å…¥ 12 æˆ– 12%ï¼‰</div>
    </div>

    <div id="inputScroll">
      <table id="tbl" aria-label="åŸºé‡‘è¼¸å…¥è¡¨">
        <thead>
          <tr>
            <th scope="col" style="min-width:220px">åŸºé‡‘åç¨±</th>
            <th scope="col">3M</th><th scope="col">6M</th><th scope="col">1Y</th><th scope="col">3Y</th><th scope="col">5Y</th>
            <th scope="col">Coverage</th><th scope="col">GC</th><th scope="col">TWR</th><th scope="col">MWR</th><th scope="col">SAR</th><th scope="col">RSI</th><th scope="col">MOMO</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- åŒ¯å‡ºæ¬„ä½ï¼ˆåŒæ­¥æ‘˜è¦è¡¨ï¼‰ -->
    <div class="export-bar">
      <strong style="color:var(--gold-soft);font-size:13px">åŒ¯å‡ºæ¬„ä½ï¼ˆåŒæ­¥æ‘˜è¦è¡¨ï¼‰</strong>
      <label><input type="checkbox" class="ex-col" value="Coverage" checked> Coverage</label>
      <label><input type="checkbox" class="ex-col" value="GC" checked> GC</label>
      <label><input type="checkbox" class="ex-col" value="TWR" checked> TWR</label>
      <label><input type="checkbox" class="ex-col" value="MWR" checked> MWR</label>
      <label><input type="checkbox" class="ex-col" value="SAR" checked> SAR</label>
      <label><input type="checkbox" class="ex-col" value="RSI" checked> RSI</label>
      <label><input type="checkbox" class="ex-col" value="MOMO" checked> MOMO</label>
      <div style="flex:1"></div>
      <button id="btnExport" aria-label="åŒ¯å‡º Excel">åŒ¯å‡º Excel</button>
    </div>

    <div id="msg" class="small" style="margin-top:8px;color:var(--gold-soft)"></div>
  </div>

  <!-- æ‘˜è¦è¡¨ -->
  <div class="panel" style="margin-top:12px">
    <div class="spread">
      <h3 style="margin:0;color:var(--gold-soft)">è‡ªå‹•æ‘˜è¦è¡¨ï¼ˆä¾å‹¾é¸æ¬„ä½é¡¯ç¤ºï¼‰</h3>
      <button id="btnShot">åŒ¯å‡ºæ‘˜è¦è¡¨æˆªåœ–</button>
    </div>
    <div id="summaryBox" class="summary-box">
      <table id="summaryTable">
        <thead><tr id="sumHead"></tr></thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>
  </div>

</div>

<footer>Â© MOMO è²¡å•†æ™ºåº«ï½œé›™è´ç­–ç•¥ï¼šæœˆé…æ¯ Ã— è³‡ç”¢å¢å€¼</footer>

<!-- ===== åƒæ•¸è¨­å®šï¼ˆJSONï¼‰ ===== -->
<script type="application/json" id="cfg">
{
  "weights": {
    "TWR":[0.105263,0.157894,0.210526,0.263157,0.263157],
    "MWR":[0.357143,0.285714,0.214286,0.142857,0.0]
  },
  "momo": {"twr":0.4, "mwr":0.3, "gc":0.3, "coverageBonusLow":0.85, "coverageBonusHigh":0.15}
}
</script>

<!-- å‹•æ…‹è¼‰å…¥ XLSXï¼ˆå¤š CDNï¼‰ -->
<script>
const XLSX_URLS = [
  "https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js",
  "https://unpkg.com/xlsx@0.20.3/dist/xlsx.full.min.js",
  "https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js",
  "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.3/xlsx.full.min.js",
  "https://fastly.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js",
  "https://gcore.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js"
];
function loadScript(url, timeoutMs=12000){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script'); let done=false;
    const to=setTimeout(()=>{ if(done) return; done=true; s.remove(); reject(new Error("timeout")); }, timeoutMs);
    s.src=url; s.onload=()=>{ if(done) return; done=true; clearTimeout(to); resolve(); };
    s.onerror=()=>{ if(done) return; done=true; clearTimeout(to); reject(new Error("network/error")); };
    document.head.appendChild(s);
  });
}
async function ensureXLSX(){
  if (window.XLSX) return true;
  for (const u of XLSX_URLS){
    try{ await loadScript(u, 12000); if (window.XLSX) return true; }catch(e){}
  }
  return false;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ========= å¸¸æ•¸/è¨­å®š ========= */
const CFG = JSON.parse(document.getElementById('cfg').textContent);
const TWR_WEIGHTS = CFG.weights.TWR.slice();
const MWR_WEIGHTS = CFG.weights.MWR.slice();
const MOMO_W = CFG.momo;
const COLIDX = {Coverage:"cov", GC:"gc", TWR:"twr", MWR:"mwr", SAR:"sar", RSI:"rsi", MOMO:"momo"};
let currentSort = 'MOMO';
let visibleRows = 10; // æ•¸å­—æˆ– 'all'
let rowSeq = 0;

/* ========= æ¬„ä½åˆ¥å ========= */
const ALIASES = {
  name:["åŸºé‡‘åç¨±","åç¨±","fund","name","åŸºé‡‘"],
  m3:["è¿‘3æœˆ","è¿‘ä¸‰æœˆ","ä¸‰å€‹æœˆ","è¿‘3å€‹æœˆ","3m","è¿‘3æœˆ%","è¿‘3æœˆç´¯ç©%"],
  m6:["è¿‘6æœˆç´¯ç©","è¿‘å…­æœˆç´¯ç©","å…­å€‹æœˆ","è¿‘6å€‹æœˆ","6m","è¿‘6æœˆç´¯ç©%","è¿‘6æœˆ%"],
  y1:["è¿‘1å¹´","è¿‘ä¸€å¹´","1y","ä¸€å¹´","è¿‘1å¹´%"],
  y3:["è¿‘3å¹´ç´¯ç©","è¿‘ä¸‰å¹´ç´¯ç©","ä¸‰å¹´ç´¯ç©","3y","è¿‘3å¹´","ä¸‰å¹´","è¿‘3å¹´ç´¯ç©%"],
  y5:["è¿‘5å¹´ç´¯ç©","è¿‘äº”å¹´ç´¯ç©","äº”å¹´ç´¯ç©","5y","è¿‘5å¹´","äº”å¹´","è¿‘5å¹´ç´¯ç©%"]
};
const norm = s=> String(s||"").replace(/\s+/g,"").replace(/ï¼…/g,"%").replace(/%/g,"").toLowerCase();

/* ========= å·¥å…· ========= */
const fmt = {
  pct:(x,dp=2)=> Number.isFinite(x)? (x*100).toFixed(dp)+'%' : '',
  num:(x,dp=2)=> Number.isFinite(x)? x.toFixed(dp) : ''
};
function parsePct(v){
  if(v===undefined||v===null) return NaN;
  let s=String(v).replace(/[,%\sï¼Œ]/g, m => (m===','||m==='â€ƒ'||m==='ã€€'||m==='ï¼Œ')? '' : '').replace(/ï¼…/g,'%').trim();
  if(!s || s==='--') return NaN;
  const n=Number(s.endsWith('%')?s.slice(0,-1):s);
  if(!Number.isFinite(n)) return NaN;
  return n>1? n/100 : n;
}
function stdp(a){a=a.filter(Number.isFinite);if(a.length<2)return NaN;const m=a.reduce((s,v)=>s+v,0)/a.length;return Math.sqrt(a.reduce((s,v)=>s+(v-m)*(v-m),0)/a.length);}
function calcGC(v){const a=v.filter(Number.isFinite);if(a.length<2)return NaN;let ok=0;for(let i=0;i<a.length-1;i++) if(a[i]<=a[i+1]) ok++; return ok/(a.length-1);}
function normalize01(x,min,max){if(!Number.isFinite(x)||max<=min)return NaN;return (x-min)/(max-min);}
function takeValid(vals,wts){const v=[],w=[];for(let i=0;i<vals.length;i++) if(Number.isFinite(vals[i])&&wts[i]>0){v.push(vals[i]);w.push(wts[i]);}const s=w.reduce((a,b)=>a+b,0)||1;return {v,w:w.map(x=>x/s)};}
function setLamp(state,text){const lamp=document.getElementById('lamp');lamp.className='lamp '+(state==='green'?'green':state==='amber'?'amber':'red');document.getElementById('lampText').textContent=text||'';}
function debounce(fn,ms){let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),ms);}}

/* ========= æŒ‡æ¨™é›†ä¸­è¨ˆç®— ========= */
function computeMetrics(rec){
  const arr=[parsePct(rec['ä¸‰å€‹æœˆ']),parsePct(rec['å…­å€‹æœˆ']),parsePct(rec['ä¸€å¹´']),parsePct(rec['ä¸‰å¹´']),parsePct(rec['äº”å¹´'])];
  const cov = arr.filter(Number.isFinite).length/5;
  const gc  = calcGC(arr);

  const tw  = takeValid(arr,TWR_WEIGHTS);
  const mw  = takeValid(arr,MWR_WEIGHTS);
  const twr = tw.v.length? tw.v.reduce((s,v,i)=>s+v*tw.w[i],0):NaN;
  const mwr = mw.v.length? mw.v.reduce((s,v,i)=>s+v*mw.w[i],0):NaN;

  let sarB=NaN, y1=arr[2], y3=arr[3], y5=arr[4];
  if(Number.isFinite(y1)&&Number.isFinite(y3)&&Number.isFinite(y5)) sarB=0.2*y1+0.4*y3+0.4*y5;
  else if(Number.isFinite(y1)&&Number.isFinite(y3)) sarB=0.3*y1+0.7*y3;
  else if(Number.isFinite(y1)) sarB=y1;
  const sar=(Number.isFinite(sarB)&&Number.isFinite(gc))? sarB*gc : NaN;

  const vals = arr.filter(Number.isFinite);
  const avg = vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : NaN;
  const std = stdp(arr);
  const rsi = (Number.isFinite(avg)&&Number.isFinite(std)&&std>0)? avg/std : NaN;

  const twrN=normalize01(twr,-0.5,0.5), mwrN=normalize01(mwr,-0.5,0.5);
  const momoRaw=(MOMO_W.twr*twrN + MOMO_W.mwr*mwrN + MOMO_W.gc*(Number.isFinite(gc)?gc:0))*100;
  const momo=momoRaw*(MOMO_W.coverageBonusLow + MOMO_W.coverageBonusHigh*cov);

  return {cov,gc,twr,mwr,sar,rsi,momo};
}

/* ========= DOM ç”¢ç”Ÿ ========= */
function makeRowEl(obj={}){
  const tr=document.createElement('tr');
  tr.dataset.idx = (++rowSeq).toString();
  tr.innerHTML=`
    <td><input placeholder="åŸºé‡‘åç¨±" value="${obj['åŸºé‡‘åç¨±']||''}"></td>
    <td><input placeholder="3M" value="${obj['ä¸‰å€‹æœˆ']||''}"></td>
    <td><input placeholder="6M" value="${obj['å…­å€‹æœˆ']||''}"></td>
    <td><input placeholder="1Y" value="${obj['ä¸€å¹´']||''}"></td>
    <td><input placeholder="3Y" value="${obj['ä¸‰å¹´']||''}"></td>
    <td><input placeholder="5Y" value="${obj['äº”å¹´']||''}"></td>
    <td class="cov"></td><td class="gc"></td><td class="twr"></td><td class="mwr"></td><td class="sar"></td><td class="rsi"></td><td class="momo"></td>
    <td><button class="ghost btnDel" aria-label="åˆªé™¤æ­¤åˆ—">åˆª</button></td>`;
  return tr;
}
function addRow(obj={}){ document.getElementById('tbody').appendChild(makeRowEl(obj)); updateRowsInfo(); }

/* ========= è®€è¡¨æ ¼ ========= */
function readTable(){
  const rows=[]; document.querySelectorAll('#tbody tr').forEach(tr=>{
    const t=tr.querySelectorAll('td');
    rows.push({
      'åŸºé‡‘åç¨±':t[0].querySelector('input').value.trim(),
      'ä¸‰å€‹æœˆ':t[1].querySelector('input').value.trim(),
      'å…­å€‹æœˆ':t[2].querySelector('input').value.trim(),
      'ä¸€å¹´':t[3].querySelector('input').value.trim(),
      'ä¸‰å¹´':t[4].querySelector('input').value.trim(),
      'äº”å¹´':t[5].querySelector('input').value.trim(),
      _tr:tr
    });
  }); return rows;
}

/* ========= å¯«å…¥çµæœ ========= */
function renderRowMetrics(tr, m){
  tr.dataset.cov = Number.isFinite(m.cov)? m.cov : '';
  tr.dataset.gc  = Number.isFinite(m.gc)?  m.gc  : '';
  tr.dataset.twr = Number.isFinite(m.twr)? m.twr : '';
  tr.dataset.mwr = Number.isFinite(m.mwr)? m.mwr : '';
  tr.dataset.sar = Number.isFinite(m.sar)? m.sar : '';
  tr.dataset.rsi = Number.isFinite(m.rsi)? m.rsi : '';
  tr.dataset.momo= Number.isFinite(m.momo)?m.momo: '';

  const tds=tr.querySelectorAll('td');
  tds[6].textContent  = Number.isFinite(m.cov)? `${Math.round(m.cov*5)}/5` : '';
  tds[7].textContent  = Number.isFinite(m.gc)?   m.gc.toFixed(2) : '';
  tds[8].textContent  = fmt.pct(m.twr);
  tds[9].textContent  = fmt.pct(m.mwr);
  tds[10].textContent = fmt.pct(m.sar);
  tds[11].textContent = Number.isFinite(m.rsi)? m.rsi.toFixed(3) : '';
  tds[12].textContent = Number.isFinite(m.momo)? m.momo.toFixed(1) : '';
}

/* ========= ä¸»è¨ˆç®— ========= */
function calcAll(){
  const rows=readTable(); let n=0;
  rows.forEach(r=>{
    const m=computeMetrics(r);
    renderRowMetrics(r._tr, m);
    n++;
  });
  document.getElementById('msg').textContent=`å…±è¨ˆç®— ${n} ç­†ã€‚`;
  sortRowsByMetric(currentSort);
  applyVisibility();
  buildSummary();
  setLamp(n>0?'green':'red', n>0?`å·²åŒ¯å…¥/è¨ˆç®—ï¼š${n} ç­†`:'æœªåŒ¯å…¥');
}

/* ========= æ’åº ========= */
const metricKey = { TWR:"twr", MWR:"mwr", SAR:"sar", RSI:"rsi", MOMO:"momo" };
function getMetricValue(tr, key){
  const v=Number(tr.dataset[key]);
  return Number.isFinite(v) ? v : -Infinity;
}
function sortRowsByMetric(metric){
  currentSort = metric;
  const tb=document.getElementById('tbody');
  const rows=Array.from(tb.querySelectorAll('tr'));
  const key = metricKey[metric] || "momo";
  rows.sort((a,b)=>{
    const va=getMetricValue(a,key), vb=getMetricValue(b,key);
    if(vb!==va) return vb-va; // é«˜â†’ä½
    return Number(a.dataset.idx)-Number(b.dataset.idx);
  });
  const frag=document.createDocumentFragment();
  rows.forEach(r=>frag.appendChild(r));
  tb.appendChild(frag);
  document.querySelectorAll('#sortGroup .chip').forEach(c=> c.classList.toggle('active', c.dataset.m===metric));
  saveUI();
}

/* ========= é¡¯ç¤ºè¡Œæ•¸ï¼ˆä¸‹æ‹‰ï¼‰ï¼‹ç¯©é¸ï¼‹æ»¾å‹• ========= */
function updateRowsInfo(){
  const total = document.querySelectorAll('#tbody tr').length || 0;
  const selVal = document.getElementById('rowsSelect').value;
  visibleRows = (selVal==='all') ? 'all' : Math.max(1, parseInt(selVal,10));
  const info = (visibleRows==='all') ? `ï¼ˆå…± ${total} åˆ—ï¼›é¡¯ç¤ºå…¨éƒ¨ï¼‰` : `ï¼ˆå…± ${total} åˆ—ï¼›é¡¯ç¤º ${visibleRows} è¡Œï¼‰`;
  document.getElementById('rowsInfo').textContent = info;
}
function applyVisibility(){
  const keyword = (document.getElementById('filterName').value||'').trim().toLowerCase();
  const onlyComputed = document.getElementById('chkComputed').checked;
  const trs = Array.from(document.querySelectorAll('#tbody tr'));
  // å…ˆä¾æ¢ä»¶éæ¿¾
  let filtered = trs.filter(tr=>{
    const name = tr.querySelector('td:first-child input').value.trim().toLowerCase();
    if(keyword && !name.includes(keyword)) return false;
    if(onlyComputed && !Number.isFinite(Number(tr.dataset.momo))) return false;
    return true;
  });
  // é¡¯ç¤ºè¡Œæ•¸
  trs.forEach(tr=>tr.classList.add('hidden-row'));
  const limit = (visibleRows==='all') ? filtered.length : visibleRows;
  filtered.slice(0, limit).forEach(tr=>tr.classList.remove('hidden-row'));
  updateRowsInfo();
}

/* ========= æ‘˜è¦è¡¨ ========= */
function getCheckedCols(){ return Array.from(document.querySelectorAll('.ex-col:checked')).map(x=>x.value); }
function buildSummary(){
  const cols=getCheckedCols();
  const head=document.getElementById('sumHead'); const body=document.getElementById('summaryBody');
  head.innerHTML=''; body.innerHTML='';
  const thName=document.createElement('th'); thName.textContent='åŸºé‡‘åç¨±'; thName.style.minWidth='240px'; thName.style.textAlign='left'; head.appendChild(thName);
  cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; head.appendChild(th); });

  const frag=document.createDocumentFragment();
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    const name=tr.querySelector('td:nth-child(1) input').value.trim(); if(!name) return;
    const trSum=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.style.textAlign='left'; tdName.textContent=name; trSum.appendChild(tdName);
    cols.forEach(c=>{
      const k = COLIDX[c];
      const td=document.createElement('td');
      const v=Number(tr.dataset[k]);
      if(c==="RSI") td.textContent = Number.isFinite(v)? v.toFixed(3) : '';
      else if(["TWR","MWR","SAR"].includes(c)) td.textContent = fmt.pct(v);
      else if(c==="MOMO") td.textContent = Number.isFinite(v)? v.toFixed(1) : '';
      else if(c==="GC") td.textContent = Number.isFinite(v)? v.toFixed(2) : '';
      else if(c==="Coverage") td.textContent = tr.dataset.cov? `${Math.round(Number(tr.dataset.cov)*5)}/5` : '';
      trSum.appendChild(td);
    });
    frag.appendChild(trSum);
  });
  body.appendChild(frag);
}

/* ========= åŒ¯å‡º Excel ========= */
function exportExcel(){
  if (!window.XLSX){ alert('XLSX æœªè¼‰å…¥ï¼Œç„¡æ³•åŒ¯å‡ºã€‚'); return; }
  const cols=getCheckedCols();
  const header=["åŸºé‡‘åç¨±","3M","6M","1Y","3Y","5Y"].concat(cols);
  const data=[header];
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    const t=tr.querySelectorAll('td');
    const row=[
      t[0].querySelector('input').value.trim(),
      t[1].querySelector('input').value.trim(),
      t[2].querySelector('input').value.trim(),
      t[3].querySelector('input').value.trim(),
      t[4].querySelector('input').value.trim(),
      t[5].querySelector('input').value.trim()
    ];
    cols.forEach(c=>{
      const k=COLIDX[c]; const v=Number(tr.dataset[k]);
      if(c==="RSI") row.push(Number.isFinite(v)? v.toFixed(3) : '');
      else if(["TWR","MWR","SAR"].includes(c)) row.push(Number.isFinite(v)? (v*100).toFixed(2)+'%' : '');
      else if(c==="MOMO") row.push(Number.isFinite(v)? v.toFixed(1) : '');
      else if(c==="GC") row.push(Number.isFinite(v)? v.toFixed(2) : '');
      else if(c==="Coverage") row.push(tr.dataset.cov? `${Math.round(Number(tr.dataset.cov)*5)}/5` : '');
      else row.push('');
    });
    data.push(row);
  });
  const ws=XLSX.utils.aoa_to_sheet(data); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "CPå€¼åˆ†æ"); XLSX.writeFile(wb, "FundMetricPro_Export.xlsx");
}

/* ========= åŒ¯å…¥ï¼ˆç²¾ç°¡ï¼‰ ========= */
async function importFile(file){
  setLamp('amber','è®€å–ä¸­â€¦');
  const ok = await ensureXLSX();
  if(!ok){ setLamp('red','æœªåŒ¯å…¥'); document.getElementById('msg').textContent='åŒ¯å…¥å¤±æ•—ï¼šç„¡æ³•è¼‰å…¥ XLSXã€‚'; return; }

  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      let json=XLSX.utils.sheet_to_json(ws,{defval:"",raw:false});
      let rowsUse = mapJsonRows(json);
      if(rowsUse.length===0){
        const arr=XLSX.utils.sheet_to_json(ws,{header:1,defval:"",raw:false});
        rowsUse = mapArrayRows(arr);
      }
      if(rowsUse.length===0){
        setLamp('red','æœªåŒ¯å…¥'); document.getElementById('msg').textContent='åŒ¯å…¥å¤±æ•—ï¼šè¡¨é ­ä¸ç¬¦æˆ–å…§å®¹ç‚ºç©ºã€‚'; return;
      }
      document.getElementById('tbody').innerHTML='';
      const frag=document.createDocumentFragment();
      rowsUse.forEach(r=>frag.appendChild(makeRowEl(r)));
      document.getElementById('tbody').appendChild(frag);

      calcAll();
      setLamp('green',`å·²åŒ¯å…¥ ${rowsUse.length} ç­†`);
      document.getElementById('msg').textContent=`å·²åŒ¯å…¥ ${rowsUse.length} ç­†ï¼Œè‡ªå‹•è¨ˆç®—å®Œæˆã€‚`;
    }catch(err){
      setLamp('red','æœªåŒ¯å…¥'); document.getElementById('msg').textContent='åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆå…§å®¹æˆ–æ ¼å¼ç„¡æ³•è§£æã€‚';
    }finally{ saveUI(); }
  };
  reader.readAsArrayBuffer(file);
}

/* â€”â€” æ˜ å°„ï¼ˆç‰©ä»¶/é™£åˆ—ï¼‰ â€”â€” */
function mapJsonRows(json){
  const lookup={}; for(const k in ALIASES){ ALIASES[k].forEach(a=>lookup[norm(a)]=k); }
  const rows=json.map(r=>{
    const tmp={}; Object.keys(r).forEach(c=>{ const k=lookup[norm(c)]; if(k) tmp[k]=r[c]; });
    return {"åŸºé‡‘åç¨±":tmp.name||"","ä¸‰å€‹æœˆ":tmp.m3||"","å…­å€‹æœˆ":tmp.m6||"","ä¸€å¹´":tmp.y1||"","ä¸‰å¹´":tmp.y3||"","äº”å¹´":tmp.y5||""};
  }).filter(r=>r["åŸºé‡‘åç¨±"]||["ä¸‰å€‹æœˆ","å…­å€‹æœˆ","ä¸€å¹´","ä¸‰å¹´","äº”å¹´"].some(k=>String(r[k]).trim()!==""));
  return rows;
}
function mapArrayRows(arr){
  if(!arr || arr.length<2) return [];
  const header=arr[0].map(h=>String(h||""));
  const idx = {};
  for(const key in ALIASES){
    const targets = ALIASES[key].map(norm);
    idx[key] = header.findIndex(h=>targets.includes(norm(h)));
  }
  const rows=[];
  for(let i=1;i<arr.length;i++){
    const row=arr[i]||[];
    const rec={
      "åŸºé‡‘åç¨±": idx.name>=0? row[idx.name] :"",
      "ä¸‰å€‹æœˆ":   idx.m3>=0? row[idx.m3] :"",
      "å…­å€‹æœˆ":   idx.m6>=0? row[idx.m6] :"",
      "ä¸€å¹´":     idx.y1>=0? row[idx.y1] :"",
      "ä¸‰å¹´":     idx.y3>=0? row[idx.y3] :"",
      "äº”å¹´":     idx.y5>=0? row[idx.y5] :""
    };
    const hasValues = ["ä¸‰å€‹æœˆ","å…­å€‹æœˆ","ä¸€å¹´","ä¸‰å¹´","äº”å¹´"].some(k => String(rec[k]||"").trim()!=="");
    const keep = String(rec["åŸºé‡‘åç¨±"]||"").trim()!=="" || hasValues;
    if(keep) rows.push(rec);
  }
  return rows;
}

/* ========= æˆªåœ– ========= */
function shotSummary(){
  html2canvas(document.getElementById('summaryBox'),{backgroundColor:'#0A1221',scale:2}).then(c=>{
    const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download=`FundMetricPro_Summary_${new Date().toISOString().slice(0,10)}.png`; a.click();
  });
}

/* ========= UI æŒä¹…åŒ– ========= */
function saveUI(){
  const payload = {
    sort: currentSort,
    rowsSel: document.getElementById('rowsSelect').value,
    cols: getCheckedCols(),
    keyword: document.getElementById('filterName').value || '',
    computed: document.getElementById('chkComputed').checked,
    compact: document.getElementById('chkCompact').checked
  };
  localStorage.setItem('fundmetric-ui', JSON.stringify(payload));
}
function loadUI(){
  try{
    const raw = localStorage.getItem('fundmetric-ui'); if(!raw) return;
    const u = JSON.parse(raw)||{};
    if(u.sort && metricKey[u.sort]) currentSort = u.sort;
    if(u.rowsSel){ document.getElementById('rowsSelect').value = u.rowsSel; }
    document.getElementById('filterName').value = u.keyword || '';
    document.getElementById('chkComputed').checked = !!u.computed;
    document.getElementById('chkCompact').checked = !!u.compact;
    document.getElementById('tbl').classList.toggle('compact', !!u.compact);
    if(Array.isArray(u.cols)){
      document.querySelectorAll('.ex-col').forEach(cb=>{ cb.checked = u.cols.includes(cb.value); });
    }
    updateRowsInfo();
    document.querySelectorAll('#sortGroup .chip').forEach(c=> c.classList.toggle('active', c.dataset.m===currentSort));
  }catch(e){}
}

/* ========= äº‹ä»¶ ========= */
const debouncedRecalc = debounce(()=>calcAll(), 300);

document.getElementById('btnAdd').onclick=()=>{ addRow({}); setLamp('amber','æ‰‹å‹•è¼¸å…¥ä¸­'); applyVisibility(); saveUI(); };
document.getElementById('btnClear').onclick=()=>{
  document.getElementById('tbody').innerHTML='';
  document.getElementById('fileInput').value='';
  document.getElementById('sumHead').innerHTML='';
  document.getElementById('summaryBody').innerHTML='';
  document.getElementById('msg').textContent='';
  setLamp('red','æœªåŒ¯å…¥');
  updateRowsInfo(); applyVisibility(); saveUI();
};
document.getElementById('btnCalc').onclick=calcAll;
document.getElementById('btnExport').onclick=exportExcel;
document.getElementById('btnShot').onclick=shotSummary;
document.getElementById('btnImport').onclick=()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange=e=>{const f=e.target.files[0]; if(f) importFile(f);};

document.getElementById('sortGroup').addEventListener('click',e=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  const m=btn.dataset.m; if(!m) return;
  sortRowsByMetric(m); applyVisibility(); buildSummary(); saveUI();
});

document.getElementById('tbody').addEventListener('click',e=>{
  if(e.target.classList.contains('btnDel')){
    const tr=e.target.closest('tr'); tr.remove(); updateRowsInfo(); applyVisibility(); buildSummary(); saveUI();
  }
});
document.getElementById('tbody').addEventListener('input',e=>{
  if(e.target.tagName==='INPUT'){ setLamp('amber','è¼¸å…¥è®Šæ›´ä¸­â€¦'); debouncedRecalc(); }
});
document.querySelectorAll('.ex-col').forEach(cb=>cb.addEventListener('change',()=>{ buildSummary(); saveUI(); }));

document.getElementById('rowsSelect').addEventListener('change',()=>{ updateRowsInfo(); applyVisibility(); saveUI(); });
document.getElementById('filterName').addEventListener('input',()=>{ applyVisibility(); saveUI(); });
document.getElementById('chkComputed').addEventListener('change',()=>{ applyVisibility(); saveUI(); });
document.getElementById('chkCompact').addEventListener('change',e=>{
  document.getElementById('tbl').classList.toggle('compact', e.target.checked);
  saveUI();
});

/* ========= åˆå§‹ ========= */
addRow({}); // åˆå§‹ç©ºç™½åˆ—
loadUI();
applyVisibility();
setLamp('red','æœªåŒ¯å…¥');
</script>

<!-- ===== momo-metric Web Componentï¼ˆæŒ‡æ¨™èªªæ˜ï¼‰ ===== -->
<script>
class MomoMetric extends HTMLElement{
  static get observedAttributes(){ return ['title']; }
  constructor(){
    super();
    const root = this.attachShadow({mode:'open'});
    root.innerHTML = `
      <style>
      :host{
        --deep:#0A1221; --card:#0C152A; --ink:#EDEFF5; --muted:#A7B0C0;
        --gold:#C9A227; --gold-soft:#E9D18A; --line:rgba(233,209,138,.22);
        display:block; font-family:inherit; color:var(--ink);
      }
      .wrap{margin:8px 0 0; padding:0; max-width:100%}
      .title{margin:0 0 10px; font-size:18px; color:var(--gold-soft); letter-spacing:.5px}
      .grid{display:grid; grid-template-columns:repeat(5,1fr); gap:12px}
      .card{
        background:linear-gradient(180deg, rgba(12,21,42,.88), rgba(10,18,33,.96));
        border:1px solid var(--line);
        border-radius:14px;
        padding:14px;
        color:var(--ink);
        position:relative;
      }
      .head{display:flex; align-items:center; gap:10px; margin-bottom:8px}
      .emoji{font-size:20px; line-height:1}
      .acr{font-weight:800; letter-spacing:.5px}
      .sub{font-size:12px; color:var(--muted)}
      .points{margin:10px 0 8px 18px; padding:0; line-height:1.6}
      .points li{margin:4px 0}
      .formula{
        margin-top:8px; font-size:12px; color:var(--muted);
        border-top:1px dashed var(--line); padding-top:8px
      }
      .formula span{white-space:nowrap}

      .info{
        margin-left:auto;
        width:26px; height:26px; border-radius:50%;
        border:1px solid var(--line); background:#0F1A34; color:var(--gold-soft);
        display:inline-flex; align-items:center; justify-content:center;
        cursor:pointer; font-weight:700;
      }
      .tooltip{
        position:absolute; right:12px; top:46px; z-index:2;
        max-width:320px; padding:10px 12px; border-radius:12px;
        background:#0F1A34; color:var(--ink); border:1px solid var(--line);
        box-shadow:0 6px 20px rgba(0,0,0,.35);
        font-size:12px; line-height:1.6;
        display:none;
      }
      .card:hover .info[data-tooltip]:hover + .tooltip,
      .info[aria-expanded="true"] + .tooltip{display:block}

      @media (max-width:1200px){ .grid{grid-template-columns:repeat(4,1fr);} }
      @media (max-width:980px){ .grid{grid-template-columns:repeat(3,1fr);} }
      @media (max-width:720px){ .grid{grid-template-columns:repeat(2,1fr);} }
      @media (max-width:520px){ .grid{grid-template-columns:1fr;} .tooltip{right:10px; left:10px; max-width:unset} }
      </style>

      <section class="wrap" aria-labelledby="momo-metric-title">
        <h2 id="momo-metric-title" class="title"></h2>

        <div class="grid">
          <!-- 1) TWR -->
          <article class="card">
            <header class="head">
              <span class="emoji" aria-hidden="true">ğŸŸ¡</span>
              <div>
                <div class="acr">TWR</div>
                <div class="sub">æ™‚é–“åŠ æ¬Šå ±é…¬</div>
              </div>
              <button class="info" aria-describedby="tip-twr" aria-label="TWR èªªæ˜" data-tooltip>â“˜</button>
              <span role="tooltip" id="tip-twr" class="tooltip">
                æ¨¡æ“¬ã€Œå®šæœŸå®šé¡ã€çš„å¹³å‡å ±é…¬ï¼›æ¯æ®µæœŸé–“ç­‰æ¬Šé‡ï¼Œæ’é™¤æŠ•å…¥é‡‘é¡å¤šå¯¡å½±éŸ¿ã€‚<br>
                é«˜ TWR â‡’ é•·æœŸè¶¨å‹¢ä½³ã€è¤‡åˆ©æ•ˆæœå¥½ã€‚
              </span>
            </header>
            <ul class="points">
              <li>æ¨¡æ“¬<b>å®šæœŸå®šé¡</b>çš„å¹³å‡å ±é…¬ã€‚</li>
              <li>æ¯æ®µæœŸé–“<b>ç­‰æ¬Šé‡</b>ï¼Œä¸å—é‡‘é¡å½±éŸ¿ã€‚</li>
              <li>TWR é«˜ â†’ é•·æœŸè¶¨å‹¢èˆ‡è¤‡åˆ©å¼·ã€‚</li>
            </ul>
            <div class="formula">
              (1+TWR) = <span>âˆ(1+R<sub>t</sub>)</span><sup>1/n</sup> âˆ’ 1
            </div>
          </article>

          <!-- 2) MWR -->
          <article class="card">
            <header class="head">
              <span class="emoji" aria-hidden="true">ğŸŸ¢</span>
              <div>
                <div class="acr">MWR</div>
                <div class="sub">è³‡é‡‘åŠ æ¬Šå ±é…¬</div>
              </div>
              <button class="info" aria-describedby="tip-mwr" aria-label="MWR èªªæ˜" data-tooltip>â“˜</button>
              <span role="tooltip" id="tip-mwr" class="tooltip">
                æ¨¡æ“¬ã€Œä¸€æ¬¡æŠ•å…¥æˆ–ä¸ç­‰é¡æŠ•å…¥ã€çš„å¯¦éš›è³‡é‡‘å ±é…¬ï¼›å„æœŸé–“ä¾è³‡é‡‘æ¯”é‡åŠ æ¬Šã€‚<br>
                é«˜ MWR â‡’ è¿‘æœŸæŠ•å…¥ç¸¾æ•ˆè¡¨ç¾äº®çœ¼ã€‚
              </span>
            </header>
            <ul class="points">
              <li>æ¨¡æ“¬<b>ä¸€æ¬¡æŠ•å…¥/ä¸ç­‰é¡</b>ç¸¾æ•ˆã€‚</li>
              <li>å„æœŸä¾<b>æŠ•å…¥é‡‘é¡</b>åŠ æ¬Šã€‚</li>
              <li>MWR é«˜ â†’ è¿‘æœŸè¡¨ç¾å¼·ã€‚</li>
            </ul>
            <div class="formula">
              MWR = è§£ IRRï¼Œä½¿ <span>âˆ‘ CF<sub>t</sub> / (1+IRR)<sup>t</sup> = 0</span>
            </div>
          </article>

          <!-- 3) SAR -->
          <article class="card">
            <header class="head">
              <span class="emoji" aria-hidden="true">ğŸŸ£</span>
              <div>
                <div class="acr">SAR</div>
                <div class="sub">ç©©å®šå ±é…¬æŒ‡æ¨™</div>
              </div>
              <button class="info" aria-describedby="tip-sar" aria-label="SAR èªªæ˜" data-tooltip>â“˜</button>
              <span role="tooltip" id="tip-sar" class="tooltip">
                ç¶œåˆ 1Y/3Y/5Y çš„ä¸­é•·æœŸå ±é…¬ï¼Œå†ä¹˜ä¸Š GCï¼ˆæˆé•·ä¸€è‡´æ€§ï¼‰ã€‚<br>
                é«˜ SAR â‡’ é•·ç·šå ±é…¬ã€Œåˆå¿«åˆç©©ã€ã€‚
              </span>
            </header>
            <ul class="points">
              <li>ç¶œåˆ <b>1Y/3Y/5Y</b> è¡¨ç¾ã€‚</li>
              <li>ä¹˜ä¸Š <b>GC</b>ï¼ˆä¸€è‡´æ€§ï¼‰ã€‚</li>
              <li>SAR é«˜ â†’ é•·ç·šç©©å¥ã€‚</li>
            </ul>
            <div class="formula">
              SAR = (0.2Ã—1Y + 0.4Ã—3Y + 0.4Ã—5Y) Ã— GC
            </div>
          </article>

          <!-- 4) RSI -->
          <article class="card">
            <header class="head">
              <span class="emoji" aria-hidden="true">ğŸ”µ</span>
              <div>
                <div class="acr">RSI</div>
                <div class="sub">å ±é…¬ç©©å®šæŒ‡æ•¸</div>
              </div>
              <button class="info" aria-describedby="tip-rsi" aria-label="RSI èªªæ˜" data-tooltip>â“˜</button>
              <span role="tooltip" id="tip-rsi" class="tooltip">
                å¹³å‡å ±é…¬ Ã· å ±é…¬æ¨™æº–å·®ï¼ˆæ³¢å‹•ï¼‰ï¼›é¡å¤æ™®æ¦‚å¿µï¼Œçœ‹ã€Œç©©ä¸ç©©ã€ã€‚<br>
                é«˜ RSI â‡’ å ±é…¬å¹³é †ç©©å¥ã€‚
              </span>
            </header>
            <ul class="points">
              <li>å¹³å‡å ±é…¬ Ã· <b>æ¨™æº–å·®</b>ã€‚</li>
              <li>è©•ä¼°<b>ç©©å®šåº¦</b>ã€‚</li>
              <li>RSI é«˜ â†’ é«”è³ªä½³ã€‚</li>
            </ul>
            <div class="formula">
              RSI = <span>Avg(Return)</span> / <span>Std(Return)</span>
            </div>
          </article>

          <!-- 5) MOMO -->
          <article class="card">
            <header class="head">
              <span class="emoji" aria-hidden="true">ğŸŸ </span>
              <div>
                <div class="acr">MOMO</div>
                <div class="sub">æ•´é«”å‹•èƒ½åˆ†æ•¸</div>
              </div>
              <button class="info" aria-describedby="tip-momo" aria-label="MOMO èªªæ˜" data-tooltip>â“˜</button>
              <span role="tooltip" id="tip-momo" class="tooltip">
                ç¶œåˆ TWRï¼ˆé•·æœŸï¼‰ã€MWRï¼ˆè¿‘æœŸï¼‰ã€GCï¼ˆä¸€è‡´æ€§ï¼‰ï¼Œä¸¦ä»¥ Coverage å¾®èª¿ã€‚<br>
                é«˜ MOMO â‡’ ç©©å¥ä¸”å‹•èƒ½å¼·ã€‚
              </span>
            </header>
            <ul class="points">
              <li>ç¶œåˆ <b>TWR</b>ã€<b>MWR</b>ã€<b>GC</b>ã€‚</li>
              <li>å« <b>Coverage</b> å¾®èª¿ã€‚</li>
              <li>MOMO é«˜ â†’ å¼·è€Œç©©ã€‚</li>
            </ul>
            <div class="formula">
              MOMO = 0.4Ã—TWRâ¿ + 0.3Ã—MWRâ¿ + 0.3Ã—GCï¼ˆÃ— Coverage èª¿æ•´ï¼‰
            </div>
          </article>
        </div>
      </section>
    `;
  }
  connectedCallback(){
    const t = this.getAttribute('title') || 'åŸºé‡‘è©•åˆ†æŒ‡æ¨™èªªæ˜';
    this.shadowRoot.getElementById('momo-metric-title').textContent = t;
    // Tooltip å¯é»æ“Šé–å®šï¼ˆå†æ¬¡é»æ“Šæˆ–é»çµ„ä»¶å¤–é—œé–‰ï¼‰
    this.shadowRoot.querySelectorAll('.info').forEach(info=>{
      let locked=false;
      info.addEventListener('click',(e)=>{
        locked=!locked;
        info.setAttribute('aria-expanded',locked?'true':'false');
        const tip=info.nextElementSibling;
        if(!tip||!tip.classList.contains('tooltip'))return;
        tip.style.display=locked?'block':'';
        e.stopPropagation();
      });
    });
    // é»æ“Šå¤–é¢é—œé–‰
    document.addEventListener('click', (e)=>{
      const root = this.shadowRoot;
      if(!root) return;
      const path = e.composedPath ? e.composedPath() : [];
      const inside = path.includes(root);
      if(inside) return;
      root.querySelectorAll('.info[aria-expanded="true"]').forEach(info=>{
        info.setAttribute('aria-expanded','false');
        const tip=info.nextElementSibling;
        if(tip&&tip.classList.contains('tooltip')) tip.style.display='';
      });
    });
  }
  attributeChangedCallback(name, oldV, newV){
    if(name==='title' && this.shadowRoot){
      this.shadowRoot.getElementById('momo-metric-title').textContent = newV || 'åŸºé‡‘è©•åˆ†æŒ‡æ¨™èªªæ˜';
    }
  }
}
customElements.define('momo-metric', MomoMetric);
</script>
<!-- ===== /momo-metric ===== -->

</body>
</html>
